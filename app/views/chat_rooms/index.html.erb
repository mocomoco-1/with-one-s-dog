<% content_for(:title, t('.title')) %>

<div class="flex flex-col text-center mb-6 w-full">
  <h1 class=" text-xl font-semibold text-left">
    <i class="far fa-envelope"></i> チャット一覧
  </h1>
  <div class="mt-2 mb-2">
    <%= link_to followings_user_path(current_user), class: "font-semibold block rounded-lg border-2 border-stone-300 hover:bg-stone-200 transition" do %>
    <i class="fas fa-plus-circle"></i>フォロー中一覧から新しくチャットする
    <% end %>
  </div>
  <% if @chat_rooms.present? %>
  <% @chat_rooms.each do |chat_room| %>
  <div id="room-<%= chat_room.id %>">
    <%= link_to chat_room_path(chat_room), class: "block" do %>
    <div class="card bg-white card-compact shadow-sm p-4 flex gap-4 cursor-pointer hover:bg-gray-100 mt-1">
      <!-- 左側: アバター + 名前 -->
      <div class="flex items-center space-x-2">
        <div class="flex-shrink-0">
          <%= render "users/icon", user: chat_room.other_user(current_user), size: 50 %>
        </div>
        <div class="flex-1 flex flex-col">
          <div class="flex justify-between items-center">
            <span class="font-normal text-sm"><%= chat_room.display_name(current_user) %></span>
            <time class="time text-xs text-gray-500"><%= l chat_room.latest_message.created_at, format: :short %></time>
          </div>
          <div class="flex justify-between items-center">
            <% if chat_room.latest_message&.present? %>
            <% if chat_room.latest_message&.content.present? %>
            <p class="new-message text-sm text-left text-gray-700">
              <%= truncate(chat_room.latest_message&.content.to_s, length: 20) %>
            </p>
            <% elsif chat_room.latest_message&.images&.attached? %>
            <p class="new-message text-sm text-left text-gray-700">
              画像が送信されました
            </p>
            <% end %>
            <% end %>
            <% if chat_room.unread_count_for(current_user) > 0 %>
            <span class="unread-badge badge badge-md badge-secondary">
              <%= chat_room.unread_count_for(current_user) %>
            </span>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
  <% end %>
  <% end %>
  <% else %>
  <p>まだチャットしているユーザーさんはいません。<br>
    お悩み相談や日記でチャットしたいユーザーさんがいれば、お悩み相談や日記のユーザーさんの名前をクリックしてください。</p>
  <% end %>
</div>